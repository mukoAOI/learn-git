更高级的中断控制器APIC 

**PIC** 传统的中断控制器，只用于单处理器，多核处理器并不适用。

**APIC**（Advanced Programmable Interrupt Controller）高级可编程中断控制器，**APIC分成两部分LAPIC和I/OAPIC**,前者**LAPIC位于CPU内部**，每个CPU都有一个LAPIC**,I/OAPIC则是与外设相连**，外设发出的中断信号经过IOAPIC处理之后再发送给LAPIC，再有LAPIC决定是否交由CPU进行实际的中断处理。

![image-20250606211007637](./assets/image-20250606211007637.png)

每个**CPU**上有一个 **LAPIC** ， **I/OAPIC** 是系统芯片组一部分，各个中断消息通过总线发送接收。



中断是一个软硬协同的过程

CPU+OS



系统调用和中断在操作系统中紧密相关，但属于不同层次的概念。它们的关系可以概括为：**系统调用是用户程序请求内核服务的接口，而中断（特别是软中断）是实现系统调用的核心机制之一**。以下是详细解析：

---

### 一、核心关系
1. **系统调用的触发依赖中断**  
   - 用户程序运行在**用户态**，无权直接执行内核代码或访问硬件。
   - 当需要内核服务（如文件读写、进程创建）时，必须通过**系统调用**切换到**内核态**。
   - 这种切换的核心机制是**软中断（Software Interrupt）**，例如 x86 的 `int 0x80` 或 `syscall` 指令。

2. **中断是 CPU 的底层机制**  
   - **中断**是 CPU 响应外部事件（硬件中断）或内部事件（异常、软中断）的机制，会强制暂停当前程序，跳转到预设的中断处理程序。
   - **系统调用本质是用户程序主动触发一个软中断**，通知内核：“我需要服务！”

---

### 二、执行流程（以 Linux x86 为例）
1. **用户程序发起系统调用**  
   ```c
   write(fd, buf, size);  // 用户调用库函数
   ```
   - 库函数（如 glibc）将参数存入寄存器（`eax=系统调用号`, `ebx/ecx/edx=参数`）。
   - 执行 `int 0x80` 或 `syscall` 指令，触发软中断。

2. **CPU 响应中断**  
   - CPU 切换到内核态，根据中断号（如 `0x80`）查找**中断描述符表（IDT）**，跳转到系统调用入口（如 `system_call`）。

3. **内核处理系统调用**  
   - 内核保存用户态现场（寄存器、栈等）。
   - 根据 `eax` 中的系统调用号，在**系统调用表**中查找对应的内核函数（如 `sys_write`）。
   - 执行内核函数，完成请求（如将数据写入文件）。

4. **返回用户态**  
   - 恢复用户程序现场，通过 `iret` 或 `sysret` 指令返回用户态。
   - 用户程序继续执行。

---

### 三、关键区别
| **特性**       | **系统调用**                | **中断**                       |
| -------------- | --------------------------- | ------------------------------ |
| **触发方**     | 用户程序主动请求            | 硬件事件/CPU异常/软件指令      |
| **目的**       | 请求内核服务                | 响应外部或内部事件             |
| **特权级切换** | 用户态 → 内核态 → 用户态    | 可能涉及特权级切换（如异常）   |
| **实现机制**   | 依赖软中断（如 `int 0x80`） | 硬件中断控制器 + IDT           |
| **同步性**     | 同步（程序主动等待结果）    | 异步（硬件中断）或同步（异常） |

---

### 四、其他重要关系
1. **异常与系统调用**  
   - **异常**（如缺页、除零）属于中断的一种，由 CPU 自动触发，可能被内核转化为信号（如 SIGSEGV）通知用户程序。
   - **系统调用**是程序**主动触发**的软中断，属于“受控的异常”。

2. **现代优化：`syscall/sysret` 指令**  
   - 传统 `int 0x80` 需要查 IDT，性能较低。
   - x86-64 引入 `syscall`/`sysret` 指令，直接跳转到预设的 MSR 寄存器指定的地址，无需查表，速度更快。

3. **中断处理程序 vs 系统调用处理程序**  
   - **中断处理程序**：处理硬件中断（如键盘输入）。
   - **系统调用处理程序**：是软中断的处理函数，专用于服务用户请求。

---

### 五、总结
- **中断是基础设施**：提供 CPU 从用户态切换到内核态的底层支持。
- **系统调用是应用接口**：利用软中断机制，为用户程序提供安全访问内核服务的入口。
- **类比**：中断如同医院的急诊呼叫系统，系统调用则是患者通过呼叫按钮主动请求护士服务。

> **关键点**：没有中断机制，系统调用无法实现特权级切换；没有系统调用封装，用户程序需直接操作复杂的中断流程。两者协同实现了操作系统的安全与功能。

