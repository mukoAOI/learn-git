计算机启动时识别和构建文件系统是一个**分阶段、逐步深入**的过程，涉及到硬件固件、引导加载程序、操作系统内核以及初始内存文件系统的紧密协作。以下是详细步骤：

---

### **1. 硬件初始化与固件阶段（BIOS/UEFI）**
   - **作用**：硬件自检（POST）后，固件（BIOS/UEFI）负责定位并加载**第一阶段引导加载程序**。
   - **文件系统识别**：
     - **传统 BIOS**：不直接理解文件系统。它读取磁盘的第一个扇区（MBR，512字节），从中获取**引导代码**和分区表。
     - **UEFI**：**支持 FAT32 文件系统**！它能直接读取 `/EFI/BOOT/` 目录下的引导文件（如 `BOOTX64.EFI`），无需依赖磁盘扇区位置。

---

### **2. 引导加载程序阶段（Bootloader）**
   - **第一阶段（如 MBR 引导代码）**：
     - 仅加载第二阶段的引导程序（如 GRUB 的 `core.img`），通常位于 MBR 后的保留扇区。
     - **不涉及文件系统**：直接按扇区地址加载数据。
   - **第二阶段（如 GRUB）**：
     - **关键能力**：包含**基础文件系统驱动**（如 `ext4`, `xfs`, `fat` 等）。
     - **工作流程**：
       1. 读取配置文件（如 `/boot/grub/grub.cfg`）。
       2. 根据配置加载**内核镜像**（`vmlinuz`）和**初始内存文件系统**（`initramfs`）。
     - **文件系统识别**：通过内置驱动解析 `/boot` 所在分区的文件系统，定位文件。

---

### **3. 内核初始化阶段**
   - **内核镜像（vmlinuz）**：
     - 被引导程序加载到内存并执行。
     - **初始任务**：初始化硬件、内存管理，但**此时无法访问根文件系统**（驱动可能未加载或存储设备未初始化）。
   - **initramfs 的核心作用**：
     - **是什么**：一个压缩的 `cpio` 归档文件，包含临时根文件系统（目录结构、关键驱动、工具）。
     - **加载方式**：由引导程序直接加载到内存，内核将其解压为**临时根文件系统（tmpfs）**。
     - **关键任务**：
       1. **加载存储设备驱动**（如 SATA, NVMe, RAID 控制器驱动）。
       2. **识别根文件系统所在设备**：
          - 解析内核参数（如 `root=/dev/sda2` 或 `root=UUID=...`）。
       3. **挂载真正的根文件系统**：
          - 使用驱动访问设备，加载文件系统模块（如 `ext4`, `btrfs`）。
          - 执行 `switch_root`：将根目录切换到真正的根文件系统，卸载 `initramfs`。

> ✅ **为什么需要 initramfs？**  
> 存储设备（如 LVM、加密卷、网络存储）的驱动可能未编译进内核，或需要额外工具解密。`initramfs` 在用户态环境提供这些能力。

---

### **4. 挂载根文件系统（/）**
   - **内核参数**：通过 `root=` 指定根设备（如 `/dev/sda2` 或 `UUID=xxxx`）。
   - **挂载操作**：
     - 内核调用文件系统驱动（如 `ext4_mount()`）。
     - 验证超级块（Superblock）等元数据，确保文件系统完整。
     - 建立 VFS（虚拟文件系统）结构，将设备映射为根目录 `/`。

---

### **5. 用户空间初始化（systemd / init）**
   - **进程 1（init）**：由内核启动的第一个用户态进程（通常是 `systemd` 或 `sysvinit`）。
   - **挂载其他文件系统**：
     - 读取 `/etc/fstab` 配置文件。
     - 挂载 `/home`, `/boot`, `/var` 等分区。
     - 处理网络文件系统（NFS）、虚拟文件系统（`/proc`, `/sys`, `/dev`）。

---

### **关键问题解答**
#### **Q：计算机如何“突然”理解文件系统？**
   - **逐级搭建能力**：
     1. **固件**：UEFI 内置 FAT 驱动 → 加载 EFI 文件。
     2. **引导程序**：内置文件系统驱动（如 GRUB 的 `ext2.mod`）→ 加载内核/initramfs。
     3. **initramfs**：提供更多驱动和工具 → 挂载真实根文件系统。
     4. **内核**：最终加载所有驱动 → 完整访问所有文件系统。

#### **Q：文件系统元数据（如 Superblock）何时被读取？**
   - **首次挂载时**：当内核或 `initramfs` 挂载分区时，文件系统驱动会读取磁盘上的元数据（如 Superblock、inode 表），构建内存中的文件系统结构。

---

### **流程图总结**
```plaintext
硬件启动 → BIOS/UEFI 
  → 加载 Bootloader（Stage 1 → Stage 2） 
  → Bootloader 读取文件系统（/boot）加载 vmlinuz 和 initramfs 
  → 内核解压 initramfs 为临时根 
  → initramfs 加载存储驱动、挂载真实根文件系统 
  → 切换根目录，启动 systemd 
  → systemd 根据 /etc/fstab 挂载其他分区
```

这一过程确保了从**裸硬件**到**完整文件系统访问**的无缝过渡，每一步都依赖前一步建立的能力。